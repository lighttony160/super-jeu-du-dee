<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ® Super Jeu du DÃ© â€” Comptes sÃ©curisÃ©s</title>
  <style>
    :root { --bg: #0b0f14; --card: rgba(255,255,255,0.08); --text:#fff; --accent:#00c6ff; --accent2:#ff00c3; }
    body { margin:0; font-family: 'Poppins', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); }
    .screen { display:none; padding: 24px; }
    .active { display:block; }
    .section { background: var(--card); border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; padding: 18px; max-width: 900px; margin: 14px auto; backdrop-filter: blur(8px); }
    h1,h2,h3 { margin: 8px 0 14px; }
    input, select { width: 100%; max-width: 420px; padding: 10px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color:#fff; outline: none; margin: 8px 0; }
    button { padding: 10px 14px; border-radius: 999px; border: none; color: #fff; cursor: pointer; background: linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow: 0 8px 20px rgba(0,0,0,0.35); margin: 6px 6px 0 0; }
    .small-btn { padding: 6px 10px; font-size: 13px; }
    .badge { display:inline-block; padding: 4px 10px; border-radius: 999px; background: rgba(255,255,255,0.12); font-size: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 8px 10px; font-size: 14px; }
    .avatar-option { display:inline-block; margin: 4px; cursor: pointer; border-radius: 50%; padding: 6px; border: 2px solid transparent; }
    .avatar-option.selected { border-color: var(--accent); background: rgba(255,255,255,0.08); }
    .notification { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color:#fff; padding: 10px 16px; border-radius: 999px; box-shadow: 0 8px 20px rgba(0,0,0,0.45); opacity:0; pointer-events:none; transition: opacity 0.3s; z-index: 20; }
    .notification.show { opacity:1; pointer-events:auto; }
  </style>
</head>
<body>
  <div id="notification" class="notification"></div>

  <!-- Splash -->
  <div id="splash" class="screen active">
    <div class="section">
      <h1>ğŸ® Super Jeu du DÃ©</h1>
      <p>Multiâ€‘joueurs, validation email, suppression sÃ©curisÃ©e, limite de 3 comptes par appareil.</p>
      <button onclick="goTo('playersScreen')">Continuer</button>
    </div>
  </div>

  <!-- Players -->
  <div id="playersScreen" class="screen">
    <div class="section">
      <h2>ğŸ‘¥ Joueurs sur cet appareil (max 3)</h2>
      <div id="playersList"></div>
      <button onclick="showCreatePlayer()" id="btnCreatePlayer">CrÃ©er un joueur (+)</button>
      <button class="small-btn" onclick="goTo('splash')">Retour</button>
    </div>

    <div class="section" id="createPlayerSection" style="display:none;">
      <h3>â• Nouveau joueur</h3>
      <input type="text" id="newPlayerName" placeholder="Nom du joueur">
      <input type="email" id="newPlayerEmail" placeholder="Email du joueur">
      <input type="password" id="newPlayerCode" placeholder="Code secret (PIN)">
      <p>Choisis un avatar :</p>
      <div id="avatarChoices">
        <span class="avatar-option" data-avatar="ğŸ§‘ğŸ»â€ğŸ¤">ğŸ§‘ğŸ»â€ğŸ¤</span>
        <span class="avatar-option" data-avatar="ğŸ‘©ğŸ»â€ğŸ¤">ğŸ‘©ğŸ»â€ğŸ¤</span>
        <span class="avatar-option" data-avatar="ğŸ§‘ğŸ»â€ğŸ’»">ğŸ§‘ğŸ»â€ğŸ’»</span>
        <span class="avatar-option" data-avatar="ğŸ‘¦ğŸ»">ğŸ‘¦ğŸ»</span>
        <span class="avatar-option" data-avatar="ğŸ‘§ğŸ»">ğŸ‘§ğŸ»</span>
      </div>
      <button onclick="createPlayer()">Valider</button>
      <p class="badge">Bonus de bienvenue : 1000 FCFA (non retirable).</p>
    </div>

    <div class="section">
      <h3>ğŸ” Recherche de comptes</h3>
      <input type="text" id="searchInput" placeholder="Rechercher par nom ou email" onkeyup="filterAccounts()">
    </div>

    <div class="section">
      <h3>ğŸ“‹ Gestion des comptes</h3>
      <table id="accountsTable">
        <thead>
          <tr>
            <th>Avatar</th>
            <th>Nom</th>
            <th>Email</th>
            <th>Niveau</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Login -->
  <div id="loginScreen" class="screen">
    <div class="section">
      <h2 id="loginTitle">Connexion</h2>
      <p>Entre le code secret du joueur.</p>
      <input type="password" id="loginCode" placeholder="Code secret">
      <button onclick="loginPlayer()">Se connecter</button>
      <button class="small-btn" onclick="goTo('playersScreen')">Retour</button>
      <p id="loginMessage"></p>
    </div>
  </div>

  <!-- Validation email -->
  <div id="validationScreen" class="screen">
    <div class="section">
      <h2>ğŸ“§ Validation du compte</h2>
      <p>Un code a Ã©tÃ© envoyÃ© Ã  ton email. Entre-le ciâ€‘dessous pour activer ton compte.</p>
      <input type="text" id="validationCodeInput" placeholder="Code reÃ§u">
      <button onclick="validerCompte()">Valider mon compte</button>
      <button class="small-btn" onclick="goTo('playersScreen')">Retour</button>
      <p id="validationMessage"></p>
    </div>
  </div>

  <!-- Delete definitive confirmation -->
  <div id="deleteValidationScreen" class="screen">
    <div class="section">
      <h2>ğŸ—‘ï¸ Confirmation de suppression dÃ©finitive</h2>
      <p>Entre le code reÃ§u par email pour confirmer la suppression :</p>
      <input type="text" id="deleteCodeInput" placeholder="Code reÃ§u">
      <button onclick="validerSuppressionDefinitive()">Confirmer la suppression</button>
      <button class="small-btn" onclick="goTo('playersScreen')">Retour</button>
      <p id="deleteMessage"></p>
    </div>
  </div>

  <!-- Instructions -->
  <div id="instructions" class="screen">
    <div class="section">
      <h2>ğŸ“˜ Instructions</h2>
      <ul style="margin:0; padding-left: 18px;">
        <li>Chaque compte nÃ©cessite un email unique et une validation par code.</li>
        <li>Limite stricte de 3 comptes par appareil (localStorage).</li>
        <li>Suppression locale (rÃ©cupÃ©rable ailleurs) et suppression dÃ©finitive avec confirmation par email.</li>
      </ul>
      <button onclick="goTo('gameScreen')">Passer au jeu ğŸ²</button>
    </div>
  </div>

  <!-- Simple game screen placeholder -->
  <div id="gameScreen" class="screen">
    <div class="section">
      <h2>ğŸ¯ Jeu du DÃ© (placeholder)</h2>
      <p>Tu pourras brancher ici tes miniâ€‘jeux existants. Le systÃ¨me de comptes est prÃªt.</p>
      <button class="small-btn" onclick="goTo('playersScreen')">Changer de joueur ğŸ‘¥</button>
    </div>
  </div>

  <script>
    // ===============================
    // DonnÃ©es & Ã©tat
    // ===============================
    let players = [];
    let currentPlayerId = null;
    let selectedAvatar = null;
    let loginTargetId = null;

    const LIMITES = {
      maxLocalAccounts: 3,
      bonusBienvenue: 1000
    };

    // ===============================
    // Utilitaires UI
    // ===============================
    function showNotification(text) {
      const n = document.getElementById("notification");
      n.textContent = text;
      n.classList.add("show");
      setTimeout(() => n.classList.remove("show"), 2600);
    }

    function goTo(screen) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(screen).classList.add("active");
      if (screen === "playersScreen") {
        renderPlayersList();
        renderAccountsTable();
        filterAccounts(); // applique filtre si champ dÃ©jÃ  rempli
      }
    }

    // ===============================
    // Stockage
    // ===============================
    function savePlayers() {
      localStorage.setItem("playersSecure", JSON.stringify(players));
      localStorage.setItem("currentPlayerIdSecure", currentPlayerId === null ? "" : String(currentPlayerId));
    }

    function loadPlayers() {
      const data = localStorage.getItem("playersSecure");
      if (data) players = JSON.parse(data);
      const cur = localStorage.getItem("currentPlayerIdSecure");
      if (cur && cur !== "") currentPlayerId = parseInt(cur);
    }

    function getPlayerById(id) {
      return players.find(p => p.id === id) || null;
    }

    // ===============================
    // CrÃ©ation & validation
    // ===============================
    function showCreatePlayer() {
      const sec = document.getElementById("createPlayerSection");
      sec.style.display = sec.style.display === "none" || sec.style.display === "" ? "block" : "none";
    }

    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("avatar-option") && e.target.parentElement.id === "avatarChoices") {
        document.querySelectorAll("#avatarChoices .avatar-option").forEach(el => el.classList.remove("selected"));
        e.target.classList.add("selected");
        selectedAvatar = e.target.getAttribute("data-avatar");
      }
    });

    function emailExists(email) {
      return players.some(p => p.email?.toLowerCase() === email.toLowerCase());
    }

    function generateValidationCode() {
      return Math.floor(100000 + Math.random() * 900000).toString(); // 6 chiffres
    }

    function createPlayer() {
      const name = document.getElementById("newPlayerName").value.trim();
      const email = document.getElementById("newPlayerEmail").value.trim();
      const code = document.getElementById("newPlayerCode").value.trim();

      if (!name || !email || !code || !selectedAvatar) {
        showNotification("Remplis le nom, l'email, le code et choisis un avatar.");
        return;
      }

      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showNotification("Email invalide.");
        return;
      }

      if (emailExists(email)) {
        showNotification("â›” Cet email est dÃ©jÃ  utilisÃ©.");
        return;
      }

      if (players.length >= LIMITES.maxLocalAccounts) {
        showNotification("â›” Limite de 3 comptes atteinte sur cet appareil.");
        return;
      }

      const id = Date.now();
      const validationCode = generateValidationCode();

      const newPlayer = {
        id,
        name,
        email,
        code,
        avatar: selectedAvatar,
        soldeTotal: LIMITES.bonusBienvenue,
        soldeRetirable: 0,
        xp: 0,
        level: 1,
        stats: { played:0, wins:0, losses:0 },
        pendingValidation: true,
        validationCode
      };

      players.push(newPlayer);
      currentPlayerId = id; // pour validation immÃ©diate
      savePlayers();

      fetch("http://localhost:3000/sendValidationCode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, code: validationCode })
      })
      .then(r => r.text())
      .then(msg => showNotification(msg))
      .catch(err => console.error(err));

      // reset UI
      document.getElementById("newPlayerName").value = "";
      document.getElementById("newPlayerEmail").value = "";
      document.getElementById("newPlayerCode").value = "";
      selectedAvatar = null;
      document.querySelectorAll("#avatarChoices .avatar-option").forEach(el => el.classList.remove("selected"));
      document.getElementById("createPlayerSection").style.display = "none";

      goTo("validationScreen");
    }

    function validerCompte() {
      const enteredCode = document.getElementById("validationCodeInput").value.trim();
      const p = getPlayerById(currentPlayerId);
      if (!p) {
        document.getElementById("validationMessage").textContent = "â›” Aucun joueur sÃ©lectionnÃ©.";
        return;
      }
      if (!p.pendingValidation) {
        document.getElementById("validationMessage").textContent = "âœ… Compte dÃ©jÃ  validÃ©.";
        return;
      }
      if (p.validationCode === enteredCode) {
        p.pendingValidation = false;
        savePlayers();
        document.getElementById("validationMessage").textContent = "âœ… Compte validÃ© avec succÃ¨s !";
        showNotification("Compte activÃ© !");
        goTo("instructions");
      } else {
        document.getElementById("validationMessage").textContent = "â›” Code incorrect.";
      }
    }

    // ===============================
    // Login
    // ===============================
    function prepareLogin(playerId) {
      loginTargetId = playerId;
      const p = getPlayerById(playerId);
      if (!p) return;
      document.getElementById("loginTitle").textContent = "Connexion â€” " + p.name;
      document.getElementById("loginCode").value = "";
      document.getElementById("loginMessage").textContent = "";
      goTo("loginScreen");
    }

    function loginPlayer() {
      if (loginTargetId === null) return;
      const p = getPlayerById(loginTargetId);
      if (!p) return;
      const code = document.getElementById("loginCode").value.trim();

      if (players.length > LIMITES.maxLocalAccounts) {
        showNotification("â›” Limite de 3 comptes atteinte sur cet appareil.");
        return;
      }

      if (code !== p.code) {
        document.getElementById("loginMessage").textContent = "â›” Code incorrect.";
        return;
      }
      if (p.pendingValidation) {
        document.getElementById("loginMessage").textContent = "â³ Compte non validÃ©. VÃ©rifie ton email.";
        goTo("validationScreen");
        return;
      }

      currentPlayerId = p.id;
      savePlayers();
      showNotification("Connexion rÃ©ussie : " + p.name);
      goTo("instructions");
    }

    // ===============================
    // Suppression
    // ===============================
    function supprimerLocal(playerId) {
      const wasCurrent = currentPlayerId === playerId;
      players = players.filter(p => p.id !== playerId);
      if (wasCurrent) currentPlayerId = null;
      savePlayers();
      renderPlayersList();
      renderAccountsTable();
      filterAccounts();
      showNotification("Compte supprimÃ© de cet appareil.");
    }

    function demanderSuppressionDefinitive(playerId) {
      const p = getPlayerById(playerId);
      if (!p) { showNotification("Compte introuvable."); return; }

      fetch("http://localhost:3000/sendDeleteConfirmation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: p.email, playerId: p.id })
      })
      .then(r => r.text())
      .then(msg => showNotification(msg))
      .catch(err => console.error(err));

      currentPlayerId = p.id; // cibler pour validation
      savePlayers();
      goTo("deleteValidationScreen");
    }

    function validerSuppressionDefinitive() {
      const enteredCode = document.getElementById("deleteCodeInput").value.trim();
      const p = getPlayerById(currentPlayerId);
      if (!p) { document.getElementById("deleteMessage").textContent = "â›” Compte introuvable."; return; }

      const expectedCode = "DELETE-" + p.id;
      if (enteredCode === expectedCode) {
        players = players.filter(pl => pl.id !== p.id);
        currentPlayerId = null;
        savePlayers();
        document.getElementById("deleteMessage").textContent = "âœ… Compte supprimÃ© dÃ©finitivement.";
        showNotification("Suppression dÃ©finitive effectuÃ©e.");
        goTo("playersScreen");
      } else {
        document.getElementById("deleteMessage").textContent = "â›” Code incorrect.";
      }
    }

    // ===============================
    // Listes & tableaux
    // ===============================
    function renderPlayersList() {
      const list = document.getElementById("playersList");
      list.innerHTML = "";
      if (players.length === 0) {
        list.innerHTML = "<p>Aucun joueur sur cet appareil.</p>";
      } else {
        const sorted = [...players].sort((a,b) => b.level - a.level || b.soldeTotal - a.soldeTotal);
        sorted.forEach(p => {
          const div = document.createElement("div");
          div.className = "section";
          const status = p.pendingValidation ? "â³ En attente" : "âœ… ValidÃ©";
          div.innerHTML = `
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <div>
                <strong>${p.avatar || "ğŸ™‚"} ${p.name}</strong><br>
                <span class="badge">Email: ${p.email}</span>
                <span class="badge">Niveau ${p.level}</span>
                <span class="badge">${status}</span>
              </div>
              <div>
                <button class="small-btn" onclick="prepareLogin(${p.id})">Se connecter</button>
                <button class="small-btn" onclick="supprimerLocal(${p.id})">Supprimer local</button>
                <button class="small-btn" onclick="demanderSuppressionDefinitive(${p.id})">Supprimer dÃ©finitif</button>
              </div>
            </div>
          `;
          list.appendChild(div);
        });
      }
      const btnCreate = document.getElementById("btnCreatePlayer");
      btnCreate.disabled = players.length >= LIMITES.maxLocalAccounts;
    }

    function renderAccountsTable() {
      const tbody = document.querySelector("#accountsTable tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      if (players.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6'>Aucun joueur enregistrÃ©.</td></tr>";
        return;
      }

      players.forEach(p => {
        const statut = p.pendingValidation ? "â³ En attente" : "âœ… ValidÃ©";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.avatar || "ğŸ™‚"}</td>
          <td>${p.name}</td>
          <td>${p.email}</td>
          <td>Niveau ${p.level}</td>
          <td>${statut}</td>
          <td>
            <button class="small-btn" onclick="supprimerLocal(${p.id})">Supprimer local</button>
            <button class="small-btn" onclick="demanderSuppressionDefinitive(${p.id})">Supprimer dÃ©finitif</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterAccounts() {
      const tbody = document.querySelector("#accountsTable tbody");
      const query = (document.getElementById("searchInput")?.value || "").toLowerCase();
      if (!tbody) return;

      const filtered = players.filter(p =>
        p.name.toLowerCase().includes(query) ||
        p.email.toLowerCase().includes(query)
      );

      tbody.innerHTML = "";
      if (filtered.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6'>Aucun compte trouvÃ©.</td></tr>";
        return;
      }

      filtered.forEach(p => {
        const statut = p.pendingValidation ? "â³ En attente" : "âœ… ValidÃ©";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.avatar || "ğŸ™‚"}</td>
          <td>${p.name}</td>
          <td>${p.email}</td>
          <td>Niveau ${p.level}</td>
          <td>${statut}</td>
          <td>
            <button class="small-btn" onclick="supprimerLocal(${p.id})">Supprimer local</button>
            <button class="small-btn" onclick="demanderSuppressionDefinitive(${p.id})">Supprimer dÃ©finitif</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===============================
    // Boot
    // ===============================
    window.addEventListener("load", () => {
      loadPlayers();
      goTo("splash");
    });
  </script>
</body>
</html>
